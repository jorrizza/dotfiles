#!/bin/bash
# Druby - Switches Debian Ruby versions based on .ruby-version files
# Quick hack by @jorrizza

# The Ruby versions shipped with Debian unstable and their suffixes.
declare -A rubies
rubies["1.9.3"]="1.9.1"
rubies["2.0.0"]="2.0"
rubies["2.1.1"]="2.1"

ruby_executable=$(basename "$0")
ruby_version_file=""
ruby_version=""
ruby_suffix=""

function find_ruby_version_file () {
    if [[ -e "$1/.ruby-version" ]]; then
        ruby_version_file=$(readlink -f "$1/.ruby-version")
    elif [[ $(readlink -f $1) == "/" ]]; then
        return
    else
        find_ruby_version_file "$1/.."
    fi
}

function set_ruby_version () {
    if [[ "$ruby_version_file" ]]; then
        ruby_version=$(head -n 1 "$ruby_version_file")
    fi
}

function set_ruby_suffix () {
    if [[ $ruby_version && ${rubies[$ruby_version]} ]]; then
        ruby_suffix=${rubies[$ruby_version]}
    fi
}

find_ruby_version_file "."
set_ruby_version
set_ruby_suffix

case "$ruby_executable" in
    druby)
        if [[ "$ruby_version_file" ]]; then
            echo "Using file: $ruby_version_file"
        fi
        if [[ "$ruby_version" ]]; then
            echo "Defined version: $ruby_version"
        else
            echo "Using system ruby"
            exit
        fi
        if [[ "$ruby_suffix" ]]; then
            echo "Mapped suffix: $ruby_suffix"
        else
            echo "Ruby version unknown; using system ruby"
        fi
        ;;
    *)
        exec "/usr/bin/$ruby_executable$ruby_suffix" $@
        ;;
esac
